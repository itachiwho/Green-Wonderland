<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Green Wonderland â€¢ Portal</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <!-- LOGIN CARD -->
  <div class="center stage" id="loginStage" aria-hidden="false">
    <div class="card">
      <h1>ðŸŒ¿ Green Wonderland Portal</h1>
      <p class="muted" id="status">Checking sessionâ€¦</p>
      <div class="row gap" id="loginActions" style="display:none;">
        <button class="btn btn-primary" id="loginBtn">Login with Discord</button>
      </div>
      <p class="hint">We never use email â€” Discord ID only.</p>
    </div>
  </div>

  <!-- APP SHELL (shown after login) -->
  <div id="appShell" class="container" style="display:none;">
    <header class="topbar">
      <div>
        <div class="brand">ðŸŒ¿ Green Wonderland</div>
        <div class="muted" id="who"></div>
      </div>
      <nav class="tabs">
        <button class="tab active" data-panel="billing">Billing</button>
        <button class="tab" data-panel="history">History</button>
        <button class="tab" data-panel="revenue">Revenue</button>
        <button class="btn btn-ghost" id="logoutBtn">Logout</button>
      </nav>
    </header>

    <!-- BILLING PANEL -->
    <section id="panel-billing" class="panel">
      <div class="grid">
        <div class="card sect">
          <h3>Items</h3>
          <p class="muted">Pick items and set quantities. Prices are RP dollars.</p>
          <div id="items"></div>
        </div>
        <div class="card sect">
          <h3>Cart</h3>
          <div class="summary">
            <div class="row between"><span class="muted">Subtotal</span><span id="subtotal">$0</span></div>
            <div class="row between"><label class="muted" for="discount">Discount</label><input id="discount" type="number" min="0" value="0"/></div>
            <div class="row between total"><span>Total</span><span id="total">$0</span></div>
          </div>
          <div class="footer">
            <button id="clear" class="btn btn-ghost">Clear</button>
            <button id="save" class="btn btn-primary" disabled>Save Sale</button>
            <span id="statusBadge" class="badge" style="display:none"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORY PANEL -->
    <section id="panel-history" class="panel" hidden>
      <div class="card">
        <div class="filters">
          <label>From <input type="date" id="hFrom"></label>
          <label>To <input type="date" id="hTo"></label>
          <label id="hWhoWrap" style="display:none;">Employee
            <select id="hEmployee"></select>
          </label>
          <button id="hApply" class="btn btn-primary">Apply</button>
          <button id="hExport" class="btn btn-ghost">Export .xlsx</button>
        </div>
        <div class="kpi three">
          <div class="card kpiCard"><div class="muted">Subtotal</div><div id="hkSub" class="kpiVal">$0</div></div>
          <div class="card kpiCard"><div class="muted">Discount</div><div id="hkDis" class="kpiVal">$0</div></div>
          <div class="card kpiCard"><div class="muted">Total</div><div id="hkTot" class="kpiVal accent">$0</div></div>
        </div>
      </div>
      <div class="card mt">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Employee</th>
              <th>Sale #</th>
              <th>Item</th>
              <th class="right">Qty</th>
              <th class="right">Unit</th>
              <th class="right">Line Total</th>
              <th class="right">Sale Total</th>
            </tr>
          </thead>
          <tbody id="hRows"></tbody>
        </table>
        <div id="hEmpty" class="muted" style="display:none;margin:6px 2px;">No sales in this range.</div>
      </div>
    </section>

    <!-- REVENUE PANEL -->
    <section id="panel-revenue" class="panel" hidden>
      <div class="card">
        <div class="filters">
          <label>From <input type="date" id="rFrom"></label>
          <label>To <input type="date" id="rTo"></label>
          <label>Bucket
            <select id="rBucket">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month" selected>Month</option>
            </select>
          </label>
          <label id="rWhoWrap" style="display:none;">Employee
            <select id="rEmployee"></select>
          </label>
          <button id="rApply" class="btn btn-primary">Apply</button>
          <button id="rExport" class="btn btn-ghost">Export .xlsx</button>
        </div>
        <div class="kpi four">
          <div class="card kpiCard"><div class="muted">Orders</div><div id="rkOrders" class="kpiVal">0</div></div>
          <div class="card kpiCard"><div class="muted">Subtotal</div><div id="rkSub" class="kpiVal">$0</div></div>
          <div class="card kpiCard"><div class="muted">Discount</div><div id="rkDis" class="kpiVal">$0</div></div>
          <div class="card kpiCard"><div class="muted">Total</div><div id="rkTot" class="kpiVal accent">$0</div></div>
        </div>
      </div>
      <div class="card mt">
        <canvas id="revChart" height="260"></canvas>
      </div>
      <div class="card mt">
        <table class="table">
          <thead>
            <tr>
              <th>Bucket</th>
              <th class="right">Orders</th>
              <th class="right">Subtotal</th>
              <th class="right">Discount</th>
              <th class="right">Total</th>
            </tr>
          </thead>
          <tbody id="rRows"></tbody>
        </table>
        <div id="rEmpty" class="muted" style="display:none;margin:6px 2px;">No sales in this range.</div>
      </div>
    </section>
  </div>

  <!-- libs -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // ðŸ”§ Project details
  const SUPABASE_URL = "https://dxddmoihqdhvbqdhrqyh.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_hloy0AR6ZXEE4ECb21ntGA_LMyI4HkZ";

  // Build BASE_URL dynamically (works locally and on GitHub Pages)
  const REPO = "Green-Wonderland";
  const hasRepo = window.location.pathname.includes(`/${REPO}/`);
  const BASE_PATH = hasRepo ? `/${REPO}/` : "/";
  const BASE_URL  = window.location.origin + BASE_PATH;

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM refs
  const loginStage = document.getElementById('loginStage');
  const loginBtn   = document.getElementById('loginBtn');
  const logoutBtn  = document.getElementById('logoutBtn');
  const statusEl   = document.getElementById('status');
  const who        = document.getElementById('who');
  const appShell   = document.getElementById('appShell');

  function show(msg){
    if (statusEl) statusEl.textContent = msg;
    console.log("[auth]", msg);
  }

  function showUrlErrors() {
    const u = new URL(window.location.href);
    const err = u.searchParams.get("error_description") || u.searchParams.get("error");
    if (err) show(`OAuth error: ${decodeURIComponent(err)}`);
  }

  async function handleOAuthReturn() {
    const href = window.location.href;
    const url  = new URL(href);

    if (url.searchParams.get("code")) {
      show("Exchanging code for sessionâ€¦");
      const { error } = await supabase.auth.exchangeCodeForSession(href);
      // Clean the URL (remove ?code=â€¦)
      history.replaceState({}, "", BASE_URL);
      if (error) {
        show("Login failed: " + (error.message || "exchangeCodeForSession error"));
        return false;
      }
      show("Code exchange OK.");
      return true;
    }

    // Legacy hash flow: clean it if present
    if (href.includes("#access_token=")) {
      history.replaceState({}, "", BASE_URL);
      show("Cleaned legacy hash from URL.");
    }
    return false;
  }

  async function boot() {
    showUrlErrors();

    const didExchange = await handleOAuthReturn();

    // Always check the session after handling return
    const { data: { session }, error } = await supabase.auth.getSession();
    if (error) {
      show("Session check failed: " + error.message);
      document.getElementById('loginActions')?.style?.setProperty('display','flex');
      return;
    }
    if (session?.user) {
      show("Session found; entering appâ€¦");
      showApp(session);
      return;
    }

    // If we just exchanged but no session, warn clearly
    if (didExchange) {
      show("Code exchanged, but no session received. Double-check Supabase Auth URL settings and Discord redirect.");
    } else {
      show("You are not logged in.");
    }
    document.getElementById('loginActions')?.style?.setProperty('display','flex');
  }

  // If session appears slightly later, still enter app
  supabase.auth.onAuthStateChange((event, session) => {
    console.log("[auth state]", event, session?.user?.id);
    if (event === "SIGNED_IN" && session?.user) {
      show("Signed in via auth state.");
      showApp(session);
    }
    if (event === "SIGNED_OUT") {
      loginStage.style.display = '';
      appShell.style.display = 'none';
      show("Signed out.");
    }
  });

  loginBtn?.addEventListener('click', async () => {
    show("Redirecting to Discordâ€¦");
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'discord',
      options: {
        redirectTo: BASE_URL,  // MUST match Supabase Site URL + Redirect URL
        scopes: 'identify'     // no email
      }
    });
    if (error) show("OAuth start failed: " + error.message);
  });

  logoutBtn?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    location.href = BASE_URL;
  });

  async function showApp(session){
    const meta = session.user.user_metadata || {};
    who.textContent = `Signed in as ${meta.name || meta.full_name || 'Employee'}`;
    loginStage.style.display = 'none';
    appShell.style.display = '';
    // Your existing init calls:
    await initTabs();
    await billingInit(session);
    await historyInit(session);
    await revenueInit(session);
  }

  // Kick off auth
  boot();
</script>
</body>
</html>
