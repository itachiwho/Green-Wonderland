<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Green Wonderland â€¢ Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; display: grid; place-items: center; height: 100vh; margin: 0; background: #0b1220; color: #e5e7eb; }
    .card { background: #111827; padding: 28px; border-radius: 14px; width: min(620px, 92vw); box-shadow: 0 10px 30px #0007; }
    h1 { margin: 0 0 8px; }
    button { cursor: pointer; padding: 10px 14px; border: 0; border-radius: 10px; font-weight: 600; }
    .primary { background: #22c55e; color: #062b12; }
    .muted { background: #1f2937; color: #cbd5e1; }
    .row { display: flex; gap: 10px; margin-top: 14px; }
    pre { background:#0f172a; padding:10px; border-radius:8px; overflow:auto; max-height:220px; font-size:13px;}
  </style>
</head>
<body>
  <div class="card">
    <h1>Green Wonderland Portal</h1>
    <p id="status">Checking sessionâ€¦</p>
    <div class="row" id="actions" style="display:none;">
      <button class="primary" id="login">Login with Discord</button>
      <button class="muted" id="logout">Logout</button>
    </div>
    <p style="margin-top:12px; font-size:14px; opacity:.9;">
      After you log in the first time, weâ€™ll create your profile automatically.
    </p>
    <div style="margin-top:14px;">
      <strong>Debug:</strong>
      <pre id="debug"></pre>
    </div>
  </div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // ðŸ”§ Your project details
  const SUPABASE_URL = "https://dxddmoihqdhvbqdhrqyh.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_hloy0AR6ZXEE4ECb21ntGA_LMyI4HkZ";

  // GitHub Pages paths (must match repo name & case)
  const BASE_PATH   = "/Green-Wonderland/";
  const BASE_URL    = window.location.origin + BASE_PATH;              // e.g., .../Green-Wonderland/
  const BILLING_URL = window.location.origin + BASE_PATH + "billing.html";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const statusEl = document.getElementById('status');
  const actionsEl = document.getElementById('actions');
  const loginBtn = document.getElementById('login');
  const logoutBtn = document.getElementById('logout');
  const debugEl = document.getElementById('debug');

  const log = (data) => {
    try { debugEl.textContent += (typeof data === "string" ? data : JSON.stringify(data, null, 2)) + "\n"; } catch {}
    console.log("[index]", data);
  };

  // âœ… React to auth events (handles â€œsession arrives a bit laterâ€)
  supabase.auth.onAuthStateChange((event, session) => {
    log({ auth_event: event, uid: session?.user?.id });
    if (event === "SIGNED_IN" && session?.user) {
      window.location.href = BILLING_URL;
    }
    if (event === "SIGNED_OUT") {
      actionsEl.style.display = "flex";
      logoutBtn.style.display = "none";
      statusEl.textContent = "You are not logged in.";
    }
  });

  (async () => {
    log({ SUPABASE_URL, keyPrefix: SUPABASE_ANON_KEY.slice(0, 10) + "..." });
    log({ href: window.location.href });

    // Handle OAuth return: code flow or (older) hash tokens
    const href = window.location.href;
    const url = new URL(href);
    const hasCode = url.searchParams.get("code");
    const errDesc = url.searchParams.get("error_description");
    if (errDesc) {
      statusEl.textContent = "OAuth error: " + errDesc;
      log("OAuth error_description: " + errDesc);
    }

    if (hasCode) {
      log("Detected code param; exchanging for sessionâ€¦");
      const { error } = await supabase.auth.exchangeCodeForSession(href);
      history.replaceState({}, "", BASE_URL); // clean URL
      if (error) {
        statusEl.textContent = "Login failed: " + error.message;
        log({ exchange_error: error });
      } else {
        // Double-check session (sometimes arrives micro-lateâ€”onAuthStateChange will also catch it)
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
          window.location.href = BILLING_URL;
          return;
        } else {
          statusEl.textContent = "Code exchangedâ€”waiting for sessionâ€¦ If it doesnâ€™t redirect, click Login again.";
        }
      }
    } else if (href.includes("#access_token=")) {
      // Clean legacy implicit hash
      history.replaceState({}, "", BASE_URL);
    }

    // Check existing session
    const { data: { session }, error } = await supabase.auth.getSession();
    if (error) {
      statusEl.textContent = "Session check failed: " + error.message;
      log({ getSession_error: error });
      actionsEl.style.display = "flex";
      logoutBtn.style.display = "none";
      return;
    }

    if (session?.user) {
      window.location.href = BILLING_URL;
      return;
    } else {
      statusEl.textContent = "You are not logged in.";
      actionsEl.style.display = "flex";
      logoutBtn.style.display = "none";
    }
  })();

  // Login (scope: identify only)
  loginBtn?.addEventListener("click", async () => {
    log("Starting Discord OAuth with redirectTo=" + BASE_URL);
    const { error } = await supabase.auth.signInWithOAuth({
      provider: "discord",
      options: { redirectTo: BASE_URL, scopes: "identify" }
    });
    if (error) {
      alert("OAuth error: " + error.message);
      log({ oauth_error: error });
    }
  });

  // Logout
  logoutBtn?.addEventListener("click", async () => {
    await supabase.auth.signOut();
    location.reload();
  });
</script>
</body>
</html>
