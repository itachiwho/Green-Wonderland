<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Green Wonderland â€¢ History</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --danger:#ef4444; --ring:#22c55e55;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    a{color:#86efac;text-decoration:none}
    .container{max-width:1200px;margin-inline:auto;padding:18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--accent);color:#052e16}
    .btn-ghost{background:#1f2937;color:#cbd5e1}
    .card{background:#0f172a;border:1px solid #1e293b;border-radius:16px;box-shadow:0 10px 30px #0006;padding:14px}
    .muted{color:var(--muted)}
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    input,select{background:#0b1220;color:#e2e8f0;border:1px solid #263042;border-radius:10px;padding:8px 10px;outline:none}
    input:focus,select:focus{box-shadow:0 0 0 4px var(--ring);border-color:#22c55e}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px}
    thead th{color:#a7f3d0;font-weight:800}
    tbody tr{background:#0b1324;border:1px solid #1f2a3e}
    .right{text-align:right}
    .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi .card{display:flex;flex-direction:column;gap:6px}
    @media (max-width:900px){.kpi{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <div style="font-size:22px;font-weight:800;">ðŸŒ¿ Green Wonderland â€¢ Sales History</div>
        <div class="muted" id="who"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <a class="btn btn-ghost" href="./billing.html">Billing</a>
        <a class="btn btn-ghost" href="./index.html">Home</a>
        <button class="btn btn-ghost" id="logout">Logout</button>
      </div>
    </div>

    <div class="card">
      <div class="filters">
        <label>From <input type="date" id="from"></label>
        <label>To <input type="date" id="to"></label>
        <label id="whoWrap" style="display:none;">Employee
          <select id="employee"></select>
        </label>
        <button id="apply" class="btn btn-primary">Apply</button>
        <button id="export" class="btn btn-ghost">Export .xlsx</button>
      </div>
      <div class="kpi">
        <div class="card">
          <div class="muted">Subtotal</div>
          <div id="kpi-subtotal" style="font-size:20px;font-weight:800;">$0</div>
        </div>
        <div class="card">
          <div class="muted">Discount</div>
          <div id="kpi-discount" style="font-size:20px;font-weight:800;">$0</div>
        </div>
        <div class="card">
          <div class="muted">Total</div>
          <div id="kpi-total" style="font-size:20px;font-weight:800;color:#bbf7d0">$0</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Employee</th>
            <th>Sale #</th>
            <th>Item</th>
            <th class="right">Qty</th>
            <th class="right">Unit</th>
            <th class="right">Line Total</th>
            <th class="right">Sale Total</th>
          </tr>
        </thead>
        <tbody id="rows">
          <!-- data rows -->
        </tbody>
      </table>
      <div id="empty" class="muted" style="display:none;margin:6px 2px;">No sales in this range.</div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // ðŸ”§ Your project details
    const SUPABASE_URL = "https://dxddmoihqdhvbqdhrqyh.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_hloy0AR6ZXEE4ECb21ntGA_LMyI4HkZ";

    const BASE_PATH = "/Green-Wonderland/";
    const LOGIN_URL = window.location.origin + BASE_PATH;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const whoEl = document.getElementById('who');
    const logoutBtn = document.getElementById('logout');
    const fromEl = document.getElementById('from');
    const toEl = document.getElementById('to');
    const employeeWrap = document.getElementById('whoWrap');
    const employeeSel = document.getElementById('employee');
    const applyBtn = document.getElementById('apply');
    const exportBtn = document.getElementById('export');
    const rowsEl = document.getElementById('rows');
    const emptyEl = document.getElementById('empty');
    const kSub = document.getElementById('kpi-subtotal');
    const kDis = document.getElementById('kpi-discount');
    const kTot = document.getElementById('kpi-total');

    let session = null;
    let isAdmin = false;
    let itemsById = new Map();
    let employees = []; // [{id,name}]

    // helpers
    const money = n => `$${Math.max(0, Math.round(n||0))}`;
    const fmtDate = iso => new Date(iso).toLocaleString();

    (async () => {
      // Session required
      const { data } = await supabase.auth.getSession();
      session = data.session;
      if (!session) { window.location.href = LOGIN_URL; return; }

      // friendly name
      const meta = session.user.user_metadata || {};
      whoEl.textContent = `Signed in as ${meta.name || meta.full_name || 'Employee'}`;

      // are we admin? (uses security-definer function we created)
      try {
        const { data: adminOk } = await supabase.rpc('is_admin', { uid: session.user.id });
        isAdmin = !!adminOk;
      } catch (e) { isAdmin = false; }

      // default date range = current month
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
      fromEl.valueAsDate = start;
      toEl.valueAsDate = end;

      // preload items for names
      await loadItems();

      // load employees list for admin filter
      if (isAdmin) {
        employeeWrap.style.display = '';
        await loadEmployees();
      }

      await loadData();
    })();

    logoutBtn?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = LOGIN_URL;
    });

    applyBtn.addEventListener('click', loadData);
    exportBtn.addEventListener('click', exportXLSX);

    async function loadItems(){
      const { data, error } = await supabase
        .from('items')
        .select('id,name');
      if (error) { console.error(error); return; }
      itemsById = new Map((data||[]).map(i => [i.id, i.name]));
    }

    async function loadEmployees(){
      // admin can read profiles; employees see only themselves (policy handles it)
      const { data, error } = await supabase
        .from('profiles')
        .select('id,name')
        .order('name',{ascending:true});
      if (error) { console.error(error); return; }
      employees = data || [];
      employeeSel.innerHTML = '<option value="">All employees</option>' +
        employees.map(e => `<option value="${e.id}">${(e.name||e.id).replaceAll('<','&lt;')}</option>`).join('');
    }

    async function loadData(){
      rowsEl.innerHTML = '';
      emptyEl.style.display = 'none';

      // build date filters
      const from = fromEl.value ? new Date(fromEl.value) : null;
      const to = toEl.value ? new Date(toEl.value) : null;
      if (to) { to.setHours(23,59,59,999); }

      // sales for current user (policy) or all (admin)
      let q = supabase.from('sales').select('id, employee_id, subtotal, discount, total, created_at')
        .order('created_at',{ascending:false});
      if (from) q = q.gte('created_at', from.toISOString());
      if (to)   q = q.lte('created_at', to.toISOString());
      if (isAdmin && employeeSel.value) q = q.eq('employee_id', employeeSel.value);

      const { data: sales, error } = await q;
      if (error) { console.error(error); alert('Failed to load sales'); return; }
      if (!sales || sales.length === 0) {
        emptyEl.style.display = '';
        setKPIs([]);
        return;
      }

      // fetch sale_items for these sale ids
      const saleIds = sales.map(s => s.id);
      const { data: items, error: siErr } = await supabase
        .from('sale_items')
        .select('sale_id,item_id,qty,unit_price,line_total')
        .in('sale_id', saleIds);
      if (siErr) { console.error(siErr); alert('Failed to load sale items'); return; }

      // (optional) load employee names for admin
      let names = new Map();
      if (isAdmin) {
        const ids = [...new Set(sales.map(s => s.employee_id))];
        if (ids.length) {
          const { data: profs } = await supabase.from('profiles').select('id,name').in('id', ids);
          (profs||[]).forEach(p => names.set(p.id, p.name||p.id));
        }
      } else {
        names.set(session.user.id, (meta?.name||meta?.full_name||'Me'));
      }

      // build row list
      const bySale = new Map(); // sale_id -> array of items
      (items||[]).forEach(li => {
        if (!bySale.has(li.sale_id)) bySale.set(li.sale_id, []);
        bySale.get(li.sale_id).push(li);
      });

      const frag = document.createDocumentFragment();
      sales.forEach((s, idx) => {
        const lines = bySale.get(s.id) || [];
        if (lines.length === 0) return;

        lines.forEach((li, i) => {
          const tr = document.createElement('tr');

          const tdDate = document.createElement('td');
          if (i===0) tdDate.textContent = fmtDate(s.created_at);
          const tdEmp = document.createElement('td');
          if (i===0) tdEmp.textContent = isAdmin ? (names.get(s.employee_id) || s.employee_id) : 'â€”';
          const tdSale = document.createElement('td');
          if (i===0) tdSale.textContent = s.id;

          const tdItem = document.createElement('td');
          tdItem.textContent = itemsById.get(li.item_id) || li.item_id;

          const tdQty = document.createElement('td'); tdQty.className='right';
          tdQty.textContent = li.qty;
          const tdUnit = document.createElement('td'); tdUnit.className='right';
          tdUnit.textContent = money(li.unit_price);
          const tdLine = document.createElement('td'); tdLine.className='right';
          tdLine.textContent = money(li.line_total);
          const tdTotal = document.createElement('td'); tdTotal.className='right';
          if (i===0) tdTotal.textContent = money(s.total);

          tr.append(tdDate, tdEmp, tdSale, tdItem, tdQty, tdUnit, tdLine, tdTotal);
          frag.appendChild(tr);
        });
      });

      rowsEl.appendChild(frag);
      setKPIs(sales);
    }

    function setKPIs(sales){
      const subtotal = sales.reduce((a,s)=>a+(s.subtotal||0),0);
      const discount = sales.reduce((a,s)=>a+(s.discount||0),0);
      const total = sales.reduce((a,s)=>a+(s.total||0),0);
      kSub.textContent = money(subtotal);
      kDis.textContent = money(discount);
      kTot.textContent = money(total);
    }

    function exportXLSX(){
      // Build flat rows for export
      const table = [];
      const trs = rowsEl.querySelectorAll('tr');
      trs.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        const row = {
          Date: tds[0]?.textContent || "",
          Employee: tds[1]?.textContent || "",
          SaleID: tds[2]?.textContent || "",
          Item: tds[3]?.textContent || "",
          Qty: tds[4]?.textContent || "",
          Unit: tds[5]?.textContent || "",
          LineTotal: tds[6]?.textContent || "",
          SaleTotal: tds[7]?.textContent || ""
        };
        table.push(row);
      });

      const ws = XLSX.utils.json_to_sheet(table);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sales");
      const now = new Date();
      const fname = `GW_Sales_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb, fname);
    }
  </script>
</body>
</html>
